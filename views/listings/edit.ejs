<% layout("/layouts/boilerplate") -%>

<style> /*styling for countryInp*/
    .options {
        /* list-style: none;   */
        padding: 0;        /* Removes default padding */
    }

    .wrapper{
    
    }

    .select-btn, .options li{
        display: flex;
        cursor: pointer;
        align-items: center;
    }

    .select-btn{
        /* width: 50%; */
        height: calc(1.5em + 0.75rem + 2px); /* Equals 38px */
        padding: 0.375rem 0.75rem;           /* Vertical & horizontal padding */
        font-size: 1rem;                     /* Base font size */
        line-height: 1.5;                    /* Text spacing */

        border: 1px solid #dddfe1;
        border-radius: 0.275rem; /* 6px rounded corners */
        /* padding: 0 20px; */
        border-radius: 7px;
        background: #fff;            
        justify-content: space-between;
        position: relative;  /* Important to define positioning context */
        z-index: 9999;       /* Ensures dropdown appears above other elements */
    }

    .select-btn i{
        font-size: 23px;
        transition: transform 0.3s linear;
    }

    .wrapper.active .select-btn i{
        transform: rotate(-180deg);
    }

    .wrapper.active .select-btn{
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Blue glow */
    }

    .content{
        display: none;
        padding: 10px;
        margin-top: 15px;
        border-radius: 7px;
        background: #fff;
        position: absolute;   /* Key fix to overlap other fields */
        z-index: 9999;        /* High z-index to appear above other inputs */
        border: 1px solid #dddfe1;
    }

    .wrapper.active .content{
        display:block;
    }

    .content .search{
        position: relative;
    }

    .search i{
        left: 15px;
        color: #999;
        font-size: 20px;
        line-height: 40px;
        position: absolute;
    }

    .search input{
        height: 40px;
        width: 100%;
        outline: none;
        font-size: 1rem; 
        border-radius: 5px;
        padding: 0 15px 0 43px;
        border: 1px solid #b3b3b3;
    }

    .content .options{
        margin-top: 10px;
        margin-bottom: 0px;
        max-height: 240px;
        overflow-y: auto;
        padding-right: 7px;
        border-radius: 5px;
        border: 1px solid #dddfe1;
    }

    .options::-webkit-scrollbar{
        width: 7px;
    }
    .options::-webkit-scrollbar-track{
        background: #f1f1f1;
        border-radius: 25px;
    }
    .options::-webkit-scrollbar-thumb{
        background: #ccc;
        border-radius: 25px;
    }

    .options li{
        height: 40px;
        padding: 0 10px;
        font-size: 1rem;    
        /* font-size of options */
        border-radius: 5px;
        margin-left: 7px;
    }

    .options li:hover, li.selected{
        background: #f2f2f2;
    }

</style>

<div class="row mt-3">
    <div class="col-8 offset-2">
        <h3>Edit your Listing</h3>
        <br>
        <form method="post" action="/listings/<%= listing._id%>?_method=PUT" novalidate class="needs-validation" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input name="listing[title]" value="<%= listing.title %>" type="text" class="form-control" required>
                <div class="valid-feedback">Title looks good!</div>
                <div class="invalid-feedback">Title cannot be empty</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea name="listing[description]" class="form-control" required><%= listing.description %></textarea>
                <div class="invalid-feedback">Please enter a short description</div>
            </div>

            <!-- Display Existing Images (2 Per Row) -->
            <div class="mb-3">
                <label>Original Listing Images:</label>
                <div class="container">
                    <div class="row">
                        <% listing.images.forEach((img, index) => { %>
                            <div class="col-md-6 text-center mb-3"> <!-- 6 columns = 2 images per row -->
                                <img src="<%= img.url.replace('/upload', '/upload/w_250') %>" class="card-img-top show-img mb-2" alt="existing image">
                                <br>
                                <input type="checkbox" name="deleteImages[]" value="<%= img.filename %>">
                                <label>Delete</label>
                            </div>
                            <% if ((index + 1) % 2 === 0) { %>
                                </div><div class="row"> <!-- Close and start a new row after every 2 images -->
                            <% } %>
                        <% }); %>
                    </div>
                </div>
            </div>

            <!-- Upload New Images -->
            <div class="mb-3">
                <label for="image" class="form-label">Upload New Images</label>
                <input name="listing[images]" type="file" class="form-control" multiple>
            </div>

            <div class="row">
                <div class="mb-3 col-md-4">
                    <label for="price" class="form-label">Price</label>
                    <input name="listing[price]" value="<%= listing.price %>" type="number" class="form-control" min="1" step="1"required>
                    <div class="invalid-feedback">Price should be valid</div>
                </div>

                <!-- <div class="mb-3 col-md-4">
                    <label for="country" class="form-label">Country</label>
                    <input name="listing[country]" value="<%= listing.country %>" type="text" class="form-control" required>
                    <div class="invalid-feedback">Country name should be valid</div>
                </div> -->

                <div class="mb-3 col-md-4">
                    <label for="country" class="form-label">Country</label>
                
                    <div class="wrapper">
                        <div class="select-btn">
                            <span><%= listing.country || 'Select Country' %></span>
                            <i class="uil uil-angle-down"></i>
                        </div>
                        <div class="content">
                            <div class="search">
                                <i class="uil uil-search"></i>
                                <input name="listing[country]" value="<%= listing.country %>" placeholder="India" type="text">
                            </div>
                            <ul class="options">
                                <!-- Options will be populated via JavaScript -->
                            </ul>
                        </div>
                    </div>
                
                    <div class="invalid-feedback">Country name should be valid</div>
                </div>
                

                <div class="mb-3 col-md-4">
                    <label for="category" class="form-label">Category</label>
                    <select name="listing[category]" class="form-select" autocomplete="category" id="category" required>
                        <% const categories = ["Rooms", "Iconic Cities", "Mountains", "Castles", "Amazing Pools", "Camping", "Farms", "Arctic", "Domes", "Boats", "Play", "Beach", "Other"]; %>
                        <% categories.forEach(cat => { %>
                            <option value="<%= cat %>" <%= listing.category === cat ? "selected" : "" %>><%= cat %></option>
                        <% }); %>
                    </select>
                    <div class="invalid-feedback">Category should be selected</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="location" class="form-label">Location</label>
                <input name="listing[location]" value="<%= listing.location %>" type="text" class="form-control" required>
                <div class="invalid-feedback">Location should be valid</div>
            </div>


            <button class="btn btn-dark edit-btn mt-3 mb-5">Edit</button>
        </form>
    </div>
</div>


<script>
    document.querySelector('form').addEventListener('submit', function(e) {
        const existingImages = document.querySelectorAll('input[name="deleteImages[]"]:checked').length;
        const newImages = document.querySelector('input[name="listing[images]"]').files.length;
        const totalImages = document.querySelectorAll('.show-img').length;

        if ((totalImages - existingImages) + newImages === 0) {
            e.preventDefault();
            alert("You must have at least one image in the listing.");
        }
    });

    const wrapper = document.querySelector(".wrapper"),
      selectBtn = wrapper.querySelector(".select-btn"),
      searchInp = wrapper.querySelector("input"),
      options = wrapper.querySelector(".options");

// Array of countries
let countries = [
    "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", 
    "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
    "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus",
    "Belgium", "Belize", "Bhutan", "Bolivia", "Bosnia and Herzegovina",
    "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi",
    "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad",
    "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia",
    "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica",
    "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
    "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France",
    "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada",
    "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras",
    "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel",
    "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati",
    "Korea", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", 
    "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
    "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Mexico", 
    "Moldova", "Monaco", "Mongolia", "Morocco", "Mozambique", "Myanmar", 
    "Namibia", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", 
    "Nigeria", "North Korea", "Norway", "Oman", "Pakistan", "Palestine", 
    "Panama", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", 
    "Qatar", "Romania", "Russia", "Rwanda", "Saudi Arabia", "Senegal", 
    "Serbia", "Seychelles", "Singapore", "Slovakia", "Slovenia", "Somalia", 
    "South Africa", "South Korea", "Spain", "Sri Lanka", "Sudan", "Suriname",
    "Sweden", "Switzerland", "Syria", "Tajikistan", "Tanzania", "Thailand",
    "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan",
    "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States",
    "Uruguay", "Uzbekistan", "Vanuatu", "Venezuela", "Vietnam", "Yemen", "Zambia",
    "Zimbabwe"
];

function addCountry(selectedCountry){
    options.innerHTML = "";
    countries.forEach(country => {
        let isSelected = country === selectedCountry ? "selected" : "";
        let li = `<li onclick="updateName(this)" class="${isSelected}">${country}</li>`;
        options.insertAdjacentHTML("beforeend", li);
    })
}

// Pre-fill the dropdown if a country is already selected
addCountry(searchInp.value.trim());

function updateName(selectedLi){
    searchInp.value = "";
    addCountry(selectedLi.innerText);
    wrapper.classList.remove("active");
    selectBtn.firstElementChild.innerText = selectedLi.innerText;
    searchInp.value = selectedLi.innerText;  // Update input value on selection
}

// Search filter functionality
searchInp.addEventListener("keyup", ()=>{
    let arr = [];
    let searchedVal = searchInp.value.toLowerCase();
    arr = countries.filter(data => {
        return data.toLowerCase().startsWith(searchedVal);
    }).map(data => `<li onclick="updateName(this)">${data}</li>`).join("");
    options.innerHTML = arr ? arr : `<p>Oops! Country not found</p>`;
})

selectBtn.addEventListener("click", ()=>{
    wrapper.classList.toggle("active");
});



</script>
